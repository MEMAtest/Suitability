<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFA Suitability Assessment Form - Compliant with FCA TR24/1</title>
    <style>
        :root {
            --primary-blue: #003366;
            --secondary-blue: #4472C4;
            --light-blue: #E7F1FF;
            --gray-dark: #333333;
            --gray-medium: #666666;
            --gray-light: #E5E5E5;
            --success-green: #28A745;
            --warning-orange: #FFC107;
            --danger-red: #DC3545;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-dark);
            background-color: #F5F7FA;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-blue);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .form-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--secondary-blue);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-blue);
        }

        .btn-success {
            background-color: var(--success-green);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-orange);
            color: var(--gray-dark);
        }

        .btn-danger {
            background-color: var(--danger-red);
            color: white;
        }

        .progress-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar h3 {
            margin-bottom: 10px;
            color: var(--primary-blue);
        }

        .progress-track {
            width: 100%;
            height: 20px;
            background-color: var(--gray-light);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--success-green);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-blue);
        }

        .section-header h2 {
            color: var(--primary-blue);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .section.collapsed .section-content {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--danger-red);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 2px rgba(68, 114, 196, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .checkbox-group,
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item,
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"],
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        tr:hover {
            background-color: #F9FAFB;
        }

        .add-row-btn {
            margin-top: 10px;
        }

        .remove-btn {
            background-color: var(--danger-red);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }

        .tooltip-icon {
            background-color: var(--secondary-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: help;
        }

        .tooltip-content {
            visibility: hidden;
            width: 250px;
            background-color: var(--gray-dark);
            color: white;
            text-align: left;
            padding: 8px 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
        }

        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .auto-calc {
            background-color: var(--light-blue);
            font-weight: 600;
        }

        .summary-box {
            background-color: var(--light-blue);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .summary-box h3 {
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 51, 102, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-complete {
            background-color: var(--success-green);
        }

        .status-incomplete {
            background-color: var(--warning-orange);
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-green);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            animation: fadeInOut 2s ease-in-out;
        }

        /* ADD THESE NEW STYLES FOR GOOGLE SHEETS INTEGRATION */
        .loading {
            display: none;
            color: #007bff;
            text-align: center;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .success-message {
            display: none;
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .error-message {
            display: none;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }

        .google-status {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
            color: var(--primary-blue);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(0); }
        }

        @media print {
            .form-controls,
            .progress-bar,
            .collapse-icon,
            .add-row-btn,
            .remove-btn,
            .tooltip {
                display: none !important;
            }

            .section {
                page-break-inside: avoid;
                box-shadow: none;
                margin-bottom: 30px;
            }

            .section.collapsed .section-content {
                display: block !important;
            }

            body {
                background: white;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header-info {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Internal Suitability Assessment Form</h1>
            <div class="header-info">
                <span>FCA TR24/1 Compliant</span>
                <span id="currentDate"></span>
                <span id="autoSaveStatus">Auto-save: Active</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="form-controls">
            <button class="btn btn-primary" onclick="saveToGoogleSheets()">‚òÅÔ∏è Save to Google Sheets</button>
            <button class="btn btn-primary" onclick="saveForm()">üíæ Save Locally</button>
            <button class="btn btn-primary" onclick="loadForm()">üìÇ Load Form</button>
            <button class="btn btn-success" onclick="exportToCSV()">üìä Export CSV</button>
            <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
            <button class="btn btn-warning" onclick="printForm()">üñ®Ô∏è Print</button>
            <button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear Form</button>
        </div>

        <!-- ADD GOOGLE SHEETS STATUS AND MESSAGES -->
        <div class="google-status">
            <strong>Google Sheets Status:</strong> <span id="googleStatus">Not configured</span>
        </div>
        <div class="loading">Submitting form to Google Sheets...</div>
        <div class="success-message">Form submitted successfully! Data has been saved to Google Sheets.</div>
        <div class="error-message">Error submitting form. Please try again or save locally.</div>

        <div class="progress-bar">
            <h3>Form Completion Progress</h3>
            <div class="progress-track">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <form id="suitabilityForm">
            <!-- Section 1: Client Details & Objectives -->
            <div class="section" id="section1">
                <div class="section-header" onclick="toggleSection('section1')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status1"></span>
                        1. Client Details & Objectives
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Personal Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientRef" class="required">Client Reference</label>
                            <input type="text" id="clientRef" name="clientRef" required>
                        </div>
                        <div class="form-group">
                            <label for="title" class="required">Title</label>
                            <select id="title" name="title" required>
                                <option value="">Select Title</option>
                                <option value="Mr">Mr</option>
                                <option value="Mrs">Mrs</option>
                                <option value="Miss">Miss</option>
                                <option value="Ms">Ms</option>
                                <option value="Dr">Dr</option>
                                <option value="Prof">Prof</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName" class="required">First Name</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName" class="required">Last Name</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dob" class="required">Date of Birth</label>
                            <input type="date" id="dob" name="dob" required>
                        </div>
                        <div class="form-group">
                            <label for="niNumber">NI Number</label>
                            <input type="text" id="niNumber" name="niNumber" placeholder="AB123456C">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taxResidency" class="required">Tax Residency</label>
                            <select id="taxResidency" name="taxResidency" required>
                                <option value="">Select Country</option>
                                <option value="UK">United Kingdom</option>
                                <option value="US">United States</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="employmentStatus" class="required">Employment Status</label>
                            <select id="employmentStatus" name="employmentStatus" required>
                                <option value="">Select Status</option>
                                <option value="Employed">Employed</option>
                                <option value="Self-Employed">Self-Employed</option>
                                <option value="Retired">Retired</option>
                                <option value="Unemployed">Unemployed</option>
                                <option value="Student">Student</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address" class="required">Address</label>
                        <textarea id="address" name="address" rows="3" required></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Advice Scope</h3>
                    <div class="form-group">
                        <label for="adviceType" class="required">Advice Type</label>
                        <select id="adviceType" name="adviceType" required>
                            <option value="">Select Type</option>
                            <option value="Full">Full Financial Planning</option>
                            <option value="Investment">Investment Only</option>
                            <option value="Pension">Pension Only</option>
                            <option value="Protection">Protection Only</option>
                            <option value="Mortgage">Mortgage Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Areas of Advice
                            <span class="tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltip-content">Select all areas relevant to this advice</span>
                            </span>
                        </label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="area_investment" name="adviceAreas" value="Investment">
                                <label for="area_investment">Investment Planning</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="area_pension" name="adviceAreas" value="Pension">
                                <label for="area_pension">Pension Planning</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="area_retirement" name="adviceAreas" value="Retirement">
                                <label for="area_retirement">Retirement Income</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="area_protection" name="adviceAreas" value="Protection">
                                <label for="area_protection">Protection</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="area_estate" name="adviceAreas" value="Estate">
                                <label for="area_estate">Estate Planning</label>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Client Objectives</h3>
                    <div class="form-group">
                        <label for="primaryObjective" class="required">Primary Objective</label>
                        <textarea id="primaryObjective" name="primaryObjective" rows="3" required placeholder="Describe the client's main financial goal..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="secondaryObjectives">Secondary Objectives</label>
                        <textarea id="secondaryObjectives" name="secondaryObjectives" rows="3" placeholder="List any additional financial goals..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timeHorizon" class="required">Time Horizon</label>
                            <select id="timeHorizon" name="timeHorizon" required>
                                <option value="">Select Time Horizon</option>
                                <option value="Short">Short Term (0-3 years)</option>
                                <option value="Medium">Medium Term (3-7 years)</option>
                                <option value="Long">Long Term (7+ years)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="incomeRequirement">Income Requirement (¬£ per annum)</label>
                            <input type="number" id="incomeRequirement" name="incomeRequirement" min="0" step="1000">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Financial Assessment -->
            <div class="section" id="section2">
                <div class="section-header" onclick="toggleSection('section2')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status2"></span>
                        2. Financial Assessment
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Income Analysis</h3>
                    <div class="table-container">
                        <table id="incomeTable">
                            <thead>
                                <tr>
                                    <th>Income Source</th>
                                    <th>Current Annual (¬£)</th>
                                    <th>Expected Change (¬£)</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Employment Income</td>
                                    <td><input type="number" name="income_employment_current" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="income_employment_expected" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="text" name="income_employment_notes"></td>
                                </tr>
                                <tr>
                                    <td>Self-Employment Income</td>
                                    <td><input type="number" name="income_self_current" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="income_self_expected" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="text" name="income_self_notes"></td>
                                </tr>
                                <tr>
                                    <td>Pension Income</td>
                                    <td><input type="number" name="income_pension_current" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="income_pension_expected" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="text" name="income_pension_notes"></td>
                                </tr>
                                <tr>
                                    <td>Investment Income</td>
                                    <td><input type="number" name="income_investment_current" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="income_investment_expected" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="text" name="income_investment_notes"></td>
                                </tr>
                                <tr>
                                    <td>Rental Income</td>
                                    <td><input type="number" name="income_rental_current" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="income_rental_expected" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="text" name="income_rental_notes"></td>
                                </tr>
                                <tr>
                                    <td>Other Income</td>
                                    <td><input type="number" name="income_other_current" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="income_other_expected" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="text" name="income_other_notes"></td>
                                </tr>
                                <tr class="auto-calc">
                                    <td><strong>Total Income</strong></td>
                                    <td><strong id="totalIncomeCurrent">¬£0</strong></td>
                                    <td><strong id="totalIncomeExpected">¬£0</strong></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 30px;">Expenditure Analysis</h3>
                    <div class="table-container">
                        <table id="expenditureTable">
                            <thead>
                                <tr>
                                    <th>Expenditure Category</th>
                                    <th>Monthly (¬£)</th>
                                    <th>Annual (¬£)</th>
                                    <th>Essential?</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Mortgage/Rent</td>
                                    <td><input type="number" name="exp_mortgage_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_mortgage_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_mortgage_essential" checked></td>
                                </tr>
                                <tr>
                                    <td>Utilities</td>
                                    <td><input type="number" name="exp_utilities_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_utilities_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_utilities_essential" checked></td>
                                </tr>
                                <tr>
                                    <td>Food & Groceries</td>
                                    <td><input type="number" name="exp_food_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_food_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_food_essential" checked></td>
                                </tr>
                                <tr>
                                    <td>Transport</td>
                                    <td><input type="number" name="exp_transport_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_transport_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_transport_essential" checked></td>
                                </tr>
                                <tr>
                                    <td>Insurance</td>
                                    <td><input type="number" name="exp_insurance_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_insurance_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_insurance_essential" checked></td>
                                </tr>
                                <tr>
                                    <td>Healthcare</td>
                                    <td><input type="number" name="exp_healthcare_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_healthcare_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_healthcare_essential" checked></td>
                                </tr>
                                <tr>
                                    <td>Entertainment</td>
                                    <td><input type="number" name="exp_entertainment_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_entertainment_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_entertainment_essential"></td>
                                </tr>
                                <tr>
                                    <td>Holidays</td>
                                    <td><input type="number" name="exp_holidays_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_holidays_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_holidays_essential"></td>
                                </tr>
                                <tr>
                                    <td>Other</td>
                                    <td><input type="number" name="exp_other_monthly" min="0" step="10" onchange="calculateExpenditureAnnual(this)"></td>
                                    <td class="auto-calc"><span name="exp_other_annual">¬£0</span></td>
                                    <td><input type="checkbox" name="exp_other_essential"></td>
                                </tr>
                                <tr class="auto-calc">
                                    <td><strong>Total Expenditure</strong></td>
                                    <td><strong id="totalExpMonthly">¬£0</strong></td>
                                    <td><strong id="totalExpAnnual">¬£0</strong></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 30px;">Assets & Liabilities</h3>
                    <div class="table-container">
                        <table id="assetsTable">
                            <thead>
                                <tr>
                                    <th>Asset Type</th>
                                    <th>Description</th>
                                    <th>Value (¬£)</th>
                                    <th>Ownership</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="assetsTableBody">
                                <tr>
                                    <td>
                                        <select name="asset_type[]">
                                            <option value="Property">Property</option>
                                            <option value="Cash">Cash/Savings</option>
                                            <option value="Investment">Investments</option>
                                            <option value="Pension">Pension</option>
                                            <option value="Business">Business</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="asset_description[]"></td>
                                    <td><input type="number" name="asset_value[]" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td>
                                        <select name="asset_ownership[]">
                                            <option value="Sole">Sole</option>
                                            <option value="Joint">Joint</option>
                                            <option value="Trust">Trust</option>
                                        </select>
                                    </td>
                                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="auto-calc">
                                    <td colspan="2"><strong>Total Assets</strong></td>
                                    <td><strong id="totalAssets">¬£0</strong></td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                        <button type="button" class="btn btn-primary add-row-btn" onclick="addAssetRow()">+ Add Asset</button>
                    </div>

                    <div class="table-container" style="margin-top: 30px;">
                        <table id="liabilitiesTable">
                            <thead>
                                <tr>
                                    <th>Liability Type</th>
                                    <th>Description</th>
                                    <th>Outstanding (¬£)</th>
                                    <th>Monthly Payment (¬£)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="liabilitiesTableBody">
                                <tr>
                                    <td>
                                        <select name="liability_type[]">
                                            <option value="Mortgage">Mortgage</option>
                                            <option value="Loan">Personal Loan</option>
                                            <option value="Credit Card">Credit Card</option>
                                            <option value="Car Finance">Car Finance</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="liability_description[]"></td>
                                    <td><input type="number" name="liability_outstanding[]" min="0" step="100" onchange="calculateTotals()"></td>
                                    <td><input type="number" name="liability_payment[]" min="0" step="10"></td>
                                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="auto-calc">
                                    <td colspan="2"><strong>Total Liabilities</strong></td>
                                    <td><strong id="totalLiabilities">¬£0</strong></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <button type="button" class="btn btn-primary add-row-btn" onclick="addLiabilityRow()">+ Add Liability</button>
                    </div>

                    <div class="summary-box">
                        <h3>Financial Summary</h3>
                        <div class="summary-item">
                            <span>Net Worth (Assets - Liabilities):</span>
                            <strong id="netWorth">¬£0</strong>
                        </div>
                        <div class="summary-item">
                            <span>Annual Surplus/Deficit:</span>
                            <strong id="annualSurplus">¬£0</strong>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Pension Arrangements</h3>
                    <div class="table-container">
                        <table id="pensionTable">
                            <thead>
                                <tr>
                                    <th>Provider</th>
                                    <th>Type</th>
                                    <th>Current Value (¬£)</th>
                                    <th>Annual Contribution (¬£)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="pensionTableBody">
                                <tr>
                                    <td><input type="text" name="pension_provider[]"></td>
                                    <td>
                                        <select name="pension_type[]">
                                            <option value="DC">Defined Contribution</option>
                                            <option value="DB">Defined Benefit</option>
                                            <option value="SIPP">SIPP</option>
                                            <option value="State">State Pension</option>
                                        </select>
                                    </td>
                                    <td><input type="number" name="pension_value[]" min="0" step="100"></td>
                                    <td><input type="number" name="pension_contribution[]" min="0" step="100"></td>
                                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-primary add-row-btn" onclick="addPensionRow()">+ Add Pension</button>
                    </div>
                </div>
            </div>

            <!-- Section 3: Retirement Income Strategy Assessment -->
            <div class="section" id="section3">
                <div class="section-header" onclick="toggleSection('section3')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status3"></span>
                        3. Retirement Income Strategy Assessment
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Sustainable Income Analysis</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="retirementAge">Expected Retirement Age</label>
                            <input type="number" id="retirementAge" name="retirementAge" min="50" max="75">
                        </div>
                        <div class="form-group">
                            <label for="lifeExpectancy">Life Expectancy Planning Age</label>
                            <input type="number" id="lifeExpectancy" name="lifeExpectancy" min="70" max="100" value="90">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sustainableWithdrawalRate">Sustainable Withdrawal Rate (%)</label>
                            <input type="number" id="sustainableWithdrawalRate" name="sustainableWithdrawalRate" min="0" max="10" step="0.1" value="3.5">
                        </div>
                        <div class="form-group">
                            <label for="inflationAssumption">Inflation Assumption (%)</label>
                            <input type="number" id="inflationAssumption" name="inflationAssumption" min="0" max="10" step="0.1" value="2.5">
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Income Gap Analysis</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="requiredIncome">Required Annual Income (¬£)</label>
                            <input type="number" id="requiredIncome" name="requiredIncome" min="0" step="1000" onchange="calculateIncomeGap()">
                        </div>
                        <div class="form-group">
                            <label for="secureIncome">Secure Income (State/DB Pensions) (¬£)</label>
                            <input type="number" id="secureIncome" name="secureIncome" min="0" step="1000" onchange="calculateIncomeGap()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Income Gap (¬£)</label>
                        <input type="text" id="incomeGap" class="auto-calc" readonly value="¬£0">
                    </div>

                    <div class="form-group">
                        <label for="incomeStrategy">Proposed Income Strategy</label>
                        <textarea id="incomeStrategy" name="incomeStrategy" rows="5" placeholder="Describe the recommended approach to generating retirement income..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 4: Risk Assessment -->
            <div class="section" id="section4">
                <div class="section-header" onclick="toggleSection('section4')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status4"></span>
                        4. Risk Assessment
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Attitude to Risk</h3>
                    <div class="form-group">
                        <label for="riskProfilingTool">Risk Profiling Tool Used</label>
                        <input type="text" id="riskProfilingTool" name="riskProfilingTool" placeholder="e.g., FinaMetrica, Oxford Risk">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="riskScore">Risk Score</label>
                            <input type="number" id="riskScore" name="riskScore" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="riskCategory" class="required">Risk Category (1-7)</label>
                            <select id="riskCategory" name="riskCategory" required>
                                <option value="">Select Category</option>
                                <option value="1">1 - Very Low Risk</option>
                                <option value="2">2 - Low Risk</option>
                                <option value="3">3 - Low to Medium Risk</option>
                                <option value="4">4 - Medium Risk</option>
                                <option value="5">5 - Medium to High Risk</option>
                                <option value="6">6 - High Risk</option>
                                <option value="7">7 - Very High Risk</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Capacity for Loss</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="emergencyFund">Emergency Fund (¬£)</label>
                            <input type="number" id="emergencyFund" name="emergencyFund" min="0" step="100" onchange="calculateEmergencyMonths()">
                        </div>
                        <div class="form-group">
                            <label>Months of Coverage</label>
                            <input type="text" id="emergencyMonths" class="auto-calc" readonly value="0 months">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="maxAcceptableLoss">Maximum Acceptable Loss (%)</label>
                        <input type="number" id="maxAcceptableLoss" name="maxAcceptableLoss" min="0" max="100" step="1">
                    </div>

                    <h3 style="margin-top: 30px;">Risk Profile Reconciliation</h3>
                    <div class="form-group">
                        <label for="riskReconciliation">Risk Profile Reconciliation Notes</label>
                        <textarea id="riskReconciliation" name="riskReconciliation" rows="4" placeholder="Explain any differences between ATR and CFL assessments..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 5: Knowledge & Experience -->
            <div class="section" id="section5">
                <div class="section-header" onclick="toggleSection('section5')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status5"></span>
                        5. Knowledge & Experience
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Investment Knowledge Assessment</h3>
                    <div class="form-group">
                        <label for="investmentKnowledge" class="required">Investment Knowledge Level</label>
                        <select id="investmentKnowledge" name="investmentKnowledge" required>
                            <option value="">Select Level</option>
                            <option value="None">None - No investment knowledge</option>
                            <option value="Basic">Basic - Understands simple products</option>
                            <option value="Intermediate">Intermediate - Good understanding</option>
                            <option value="Advanced">Advanced - Sophisticated investor</option>
                        </select>
                    </div>

                    <h3 style="margin-top: 30px;">Investment Experience</h3>
                    <div class="table-container">
                        <table id="experienceTable">
                            <thead>
                                <tr>
                                    <th>Investment Type</th>
                                    <th>Years of Experience</th>
                                    <th>Current Holdings</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="experienceTableBody">
                                <tr>
                                    <td>
                                        <select name="experience_type[]">
                                            <option value="Cash">Cash/Deposits</option>
                                            <option value="Bonds">Bonds/Fixed Income</option>
                                            <option value="Equities">Equities/Shares</option>
                                            <option value="Funds">Mutual Funds/OEICs</option>
                                            <option value="ETFs">ETFs</option>
                                            <option value="Property">Property</option>
                                            <option value="Alternatives">Alternative Investments</option>
                                        </select>
                                    </td>
                                    <td><input type="number" name="experience_years[]" min="0" max="50"></td>
                                    <td>
                                        <select name="experience_current[]">
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </td>
                                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-primary add-row-btn" onclick="addExperienceRow()">+ Add Experience</button>
                    </div>
                </div>
            </div>

            <!-- Section 6: Vulnerability Assessment -->
            <div class="section" id="section6">
                <div class="section-header" onclick="toggleSection('section6')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status6"></span>
                        6. Vulnerability Assessment
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Vulnerability Indicators</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="vuln_health" name="vulnerabilities" value="Health">
                            <label for="vuln_health">Health - Physical or mental health conditions</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="vuln_life" name="vulnerabilities" value="Life Events">
                            <label for="vuln_life">Life Events - Bereavement, divorce, job loss</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="vuln_resilience" name="vulnerabilities" value="Resilience">
                            <label for="vuln_resilience">Resilience - Low financial resilience</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="vuln_capability" name="vulnerabilities" value="Capability">
                            <label for="vuln_capability">Capability - Low financial capability or confidence</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="vuln_none" name="vulnerabilities" value="None">
                            <label for="vuln_none">None identified</label>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label for="vulnerabilityDetails">Vulnerability Details</label>
                        <textarea id="vulnerabilityDetails" name="vulnerabilityDetails" rows="3" placeholder="Provide details of any vulnerabilities identified..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="adaptationsMade">Adaptations Made</label>
                        <textarea id="adaptationsMade" name="adaptationsMade" rows="3" placeholder="Describe any adaptations made to the advice process..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 7: Options Considered -->
            <div class="section" id="section7">
                <div class="section-header" onclick="toggleSection('section7')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status7"></span>
                        7. Options Considered
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Options Assessment</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="opt_nothing" name="options" value="Do Nothing">
                            <label for="opt_nothing">Do Nothing</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="opt_cash" name="options" value="Hold in Cash">
                            <label for="opt_cash">Hold in Cash</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="opt_annuity" name="options" value="Purchase Annuity">
                            <label for="opt_annuity">Purchase Annuity</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="opt_drawdown" name="options" value="Flexi-Access Drawdown">
                            <label for="opt_drawdown">Flexi-Access Drawdown</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="opt_ufpls" name="options" value="UFPLS">
                            <label for="opt_ufpls">Uncrystallised Funds Pension Lump Sum (UFPLS)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="opt_hybrid" name="options" value="Hybrid">
                            <label for="opt_hybrid">Hybrid Approach</label>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label for="optionsAdvantages">Advantages of Each Option</label>
                        <textarea id="optionsAdvantages" name="optionsAdvantages" rows="4" placeholder="Detail the advantages of each option considered..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="optionsDisadvantages">Disadvantages of Each Option</label>
                        <textarea id="optionsDisadvantages" name="optionsDisadvantages" rows="4" placeholder="Detail the disadvantages of each option considered..."></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Product Research</h3>
                    <div class="form-group">
                        <label for="productResearch">Product Research Undertaken</label>
                        <textarea id="productResearch" name="productResearch" rows="3" placeholder="Describe the product research process and tools used..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 8: Recommendation -->
            <div class="section" id="section8">
                <div class="section-header" onclick="toggleSection('section8')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status8"></span>
                        8. Recommendation
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Recommendation Summary</h3>
                    <div class="form-group">
                        <label for="recommendationSummary" class="required">Recommendation Summary</label>
                        <textarea id="recommendationSummary" name="recommendationSummary" rows="5" required placeholder="Provide a clear summary of your recommendation..."></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Income Strategy</h3>
                    <div class="form-group">
                        <label for="incomeStrategyDetail">Income Strategy Details</label>
                        <textarea id="incomeStrategyDetail" name="incomeStrategyDetail" rows="4" placeholder="Detail the recommended income withdrawal strategy..."></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Investment Strategy</h3>
                    <div class="form-group">
                        <label for="investmentStrategyDetail">Investment Strategy Details</label>
                        <textarea id="investmentStrategyDetail" name="investmentStrategyDetail" rows="4" placeholder="Detail the recommended investment approach and asset allocation..."></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Death Benefit Nominations</h3>
                    <div class="form-group">
                        <label for="deathBenefitNominations">Death Benefit Nominations</label>
                        <textarea id="deathBenefitNominations" name="deathBenefitNominations" rows="3" placeholder="Detail any death benefit nominations recommended..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 9: Suitability Assessment -->
            <div class="section" id="section9">
                <div class="section-header" onclick="toggleSection('section9')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status9"></span>
                        9. Suitability Assessment
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Suitability Criteria</h3>
                    <div class="form-group">
                        <label>Meets client objectives?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="objectives_yes" name="meetsObjectives" value="Yes" required>
                                <label for="objectives_yes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="objectives_no" name="meetsObjectives" value="No" required>
                                <label for="objectives_no">No</label>
                            </div>
                        </div>
                        <textarea name="objectivesExplanation" rows="2" placeholder="Explain how the recommendation meets objectives..." style="margin-top: 10px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Suitable for risk profile?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="risk_yes" name="suitableRisk" value="Yes" required>
                                <label for="risk_yes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="risk_no" name="suitableRisk" value="No" required>
                                <label for="risk_no">No</label>
                            </div>
                        </div>
                        <textarea name="riskExplanation" rows="2" placeholder="Explain risk suitability..." style="margin-top: 10px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Affordable for the client?</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="affordable_yes" name="affordable" value="Yes" required>
                                <label for="affordable_yes">Yes</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="affordable_no" name="affordable" value="No" required>
                                <label for="affordable_no">No</label>
                            </div>
                        </div>
                        <textarea name="affordabilityExplanation" rows="2" placeholder="Explain affordability assessment..." style="margin-top: 10px;"></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Advantages & Disadvantages</h3>
                    <div class="form-group">
                        <label for="recommendationAdvantages">Advantages of Recommendation</label>
                        <textarea id="recommendationAdvantages" name="recommendationAdvantages" rows="4" placeholder="List the key advantages..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="recommendationDisadvantages">Disadvantages of Recommendation</label>
                        <textarea id="recommendationDisadvantages" name="recommendationDisadvantages" rows="4" placeholder="List the key disadvantages..."></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Risk Warnings</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="risk_capital" name="riskWarnings" value="Capital at Risk">
                            <label for="risk_capital">Capital is at risk and can fall as well as rise</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="risk_inflation" name="riskWarnings" value="Inflation Risk">
                            <label for="risk_inflation">Inflation may erode the real value of investments</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="risk_liquidity" name="riskWarnings" value="Liquidity Risk">
                            <label for="risk_liquidity">Some investments may be difficult to sell quickly</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="risk_concentration" name="riskWarnings" value="Concentration Risk">
                            <label for="risk_concentration">Lack of diversification increases risk</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="risk_tax" name="riskWarnings" value="Tax Risk">
                            <label for="risk_tax">Tax rules can change and depend on circumstances</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 10: Costs & Charges -->
            <div class="section" id="section10">
                <div class="section-header" onclick="toggleSection('section10')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status10"></span>
                        10. Costs & Charges
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Adviser Charges</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="initialAdviserCharge">Initial Adviser Charge (¬£)</label>
                            <input type="number" id="initialAdviserCharge" name="initialAdviserCharge" min="0" step="100" onchange="calculateTotalCharges()">
                        </div>
                        <div class="form-group">
                            <label for="initialAdviserChargePercent">Initial Adviser Charge (%)</label>
                            <input type="number" id="initialAdviserChargePercent" name="initialAdviserChargePercent" min="0" max="10" step="0.1" onchange="calculateTotalCharges()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ongoingAdviserCharge">Ongoing Adviser Charge (% p.a.)</label>
                            <input type="number" id="ongoingAdviserCharge" name="ongoingAdviserCharge" min="0" max="5" step="0.1" onchange="calculateTotalCharges()">
                        </div>
                        <div class="form-group">
                            <label for="adviserChargeMethod">Payment Method</label>
                            <select id="adviserChargeMethod" name="adviserChargeMethod">
                                <option value="Deducted">Deducted from investment</option>
                                <option value="Direct">Direct payment</option>
                                <option value="Both">Combination</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Product & Investment Charges</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="platformCharge">Platform Charge (% p.a.)</label>
                            <input type="number" id="platformCharge" name="platformCharge" min="0" max="2" step="0.01" onchange="calculateTotalCharges()">
                        </div>
                        <div class="form-group">
                            <label for="fundCharges">Fund Charges (% p.a.)</label>
                            <input type="number" id="fundCharges" name="fundCharges" min="0" max="3" step="0.01" onchange="calculateTotalCharges()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Total Ongoing Charges (% p.a.)</label>
                        <input type="text" id="totalOngoingCharges" class="auto-calc" readonly value="0.00%">
                    </div>

                    <h3 style="margin-top: 30px;">Value Assessment</h3>
                    <div class="form-group">
                        <label for="valueAssessment">Value for Money Assessment</label>
                        <textarea id="valueAssessment" name="valueAssessment" rows="4" placeholder="Explain how the charges represent value for money..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 11: Documentation & Compliance -->
            <div class="section" id="section11">
                <div class="section-header" onclick="toggleSection('section11')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status11"></span>
                        11. Documentation & Compliance
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Documents Provided</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="doc_suitability" name="documents" value="Suitability Report">
                            <label for="doc_suitability">Suitability Report</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doc_kiid" name="documents" value="KIID">
                            <label for="doc_kiid">Key Information Documents (KIIDs)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doc_illustration" name="documents" value="Illustration">
                            <label for="doc_illustration">Product Illustration</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doc_costs" name="documents" value="Costs Disclosure">
                            <label for="doc_costs">Costs & Charges Disclosure</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doc_terms" name="documents" value="Terms">
                            <label for="doc_terms">Terms of Business</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="doc_privacy" name="documents" value="Privacy">
                            <label for="doc_privacy">Privacy Notice</label>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Record Keeping</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="record_meeting" name="recordKeeping" value="Meeting Notes">
                            <label for="record_meeting">Meeting notes retained</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="record_research" name="recordKeeping" value="Research">
                            <label for="record_research">Research documentation retained</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="record_calculations" name="recordKeeping" value="Calculations">
                            <label for="record_calculations">Calculations retained</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="record_correspondence" name="recordKeeping" value="Correspondence">
                            <label for="record_correspondence">Client correspondence retained</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 12: Quality Assurance & Approvals -->
            <div class="section" id="section12">
                <div class="section-header" onclick="toggleSection('section12')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status12"></span>
                        12. Quality Assurance & Approvals
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Adviser Assessment</h3>
                    <div class="form-group">
                        <label for="adviserName" class="required">Adviser Name</label>
                        <input type="text" id="adviserName" name="adviserName" required>
                    </div>
                    <div class="form-group">
                        <label for="adviserNumber" class="required">FCA Reference Number</label>
                        <input type="text" id="adviserNumber" name="adviserNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="adviserAssessment">Adviser's Assessment</label>
                        <textarea id="adviserAssessment" name="adviserAssessment" rows="4" placeholder="Confirm the suitability of the recommendation..."></textarea>
                    </div>

                    <h3 style="margin-top: 30px;">Compliance Assessment</h3>
                    <div class="form-group">
                        <label for="complianceReviewer">Compliance Reviewer Name</label>
                        <input type="text" id="complianceReviewer" name="complianceReviewer">
                    </div>
                    <div class="form-group">
                        <label for="complianceDate">Review Date</label>
                        <input type="date" id="complianceDate" name="complianceDate">
                    </div>
                    <div class="form-group">
                        <label for="complianceComments">Compliance Comments</label>
                        <textarea id="complianceComments" name="complianceComments" rows="3" placeholder="Any compliance observations or requirements..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section 13: Declarations & Signatures -->
            <div class="section" id="section13">
                <div class="section-header" onclick="toggleSection('section13')">
                    <h2>
                        <span class="status-indicator status-incomplete" id="status13"></span>
                        13. Declarations & Signatures
                    </h2>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="section-content">
                    <h3>Adviser Declaration</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="declare_suitable" name="adviserDeclaration" value="Suitable" required>
                            <label for="declare_suitable">I confirm this recommendation is suitable based on the client's circumstances</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="declare_compliant" name="adviserDeclaration" value="Compliant" required>
                            <label for="declare_compliant">I confirm this advice complies with FCA rules and guidance</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="declare_documented" name="adviserDeclaration" value="Documented" required>
                            <label for="declare_documented">I confirm all advice has been properly documented</label>
                        </div>
                    </div>

                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="adviserSignature" class="required">Adviser Signature</label>
                            <input type="text" id="adviserSignature" name="adviserSignature" required placeholder="Type full name">
                        </div>
                        <div class="form-group">
                            <label for="adviserSignDate" class="required">Date</label>
                            <input type="date" id="adviserSignDate" name="adviserSignDate" required>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">Compliance Approval</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="complianceSignature">Compliance Signature</label>
                            <input type="text" id="complianceSignature" name="complianceSignature" placeholder="Type full name">
                        </div>
                        <div class="form-group">
                            <label for="complianceSignDate">Date</label>
                            <input type="date" id="complianceSignDate" name="complianceSignDate">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="save-indicator" id="saveIndicator">Form saved successfully!</div>

    <script>
        // IMPORTANT: Replace this with your Google Apps Script URL
        const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';

        // Initialize form
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Load any saved data
            loadAutoSave();

            // Set up auto-save
            setInterval(autoSave, 30000); // Auto-save every 30 seconds

            // Set up progress tracking
            updateProgress();

            // Add event listeners for progress updates
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', updateProgress);
            });

            // Update Google Sheets status
            updateGoogleSheetsStatus();
        });

        // Google Sheets Integration
        function updateGoogleSheetsStatus() {
            const statusElement = document.getElementById('googleStatus');
            if (GOOGLE_SCRIPT_URL && GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                statusElement.textContent = 'Connected';
                statusElement.style.color = 'green';
            } else {
                statusElement.textContent = 'Not configured - Please add your Google Apps Script URL';
                statusElement.style.color = 'orange';
            }
        }

        async function saveToGoogleSheets() {
            // Check if URL is configured
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                alert('Please configure your Google Apps Script URL first!\n\nReplace YOUR_GOOGLE_APPS_SCRIPT_URL_HERE with your actual script URL in the code.');
                return;
            }

            // Hide any previous messages
            document.querySelector('.success-message').style.display = 'none';
            document.querySelector('.error-message').style.display = 'none';
            document.querySelector('.loading').style.display = 'block';
            
            // Collect all form data
            const formData = collectFormDataForGoogle();
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                // With no-cors, we can't read the response, so we assume success
                document.querySelector('.loading').style.display = 'none';
                document.querySelector('.success-message').style.display = 'block';
                
                // Hide success message after 5 seconds
                setTimeout(() => {
                    document.querySelector('.success-message').style.display = 'none';
                }, 5000);
                
            } catch (error) {
                document.querySelector('.loading').style.display = 'none';
                document.querySelector('.error-message').style.display = 'block';
                console.error('Error:', error);
                
                // Hide error message after 5 seconds
                setTimeout(() => {
                    document.querySelector('.error-message').style.display = 'none';
                }, 5000);
            }
        }

        function collectFormDataForGoogle() {
            const form = document.getElementById('suitabilityForm');
            const formData = new FormData(form);
            const data = {
                timestamp: new Date().toISOString(),
                // Section 1 - Client Details
                clientRef: document.getElementById('clientRef').value,
                title: document.getElementById('title').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                fullName: `${document.getElementById('title').value} ${document.getElementById('firstName').value} ${document.getElementById('lastName').value}`,
                dob: document.getElementById('dob').value,
                niNumber: document.getElementById('niNumber').value,
                taxResidency: document.getElementById('taxResidency').value,
                employmentStatus: document.getElementById('employmentStatus').value,
                address: document.getElementById('address').value,
                
                // Advice Scope
                adviceType: document.getElementById('adviceType').value,
                adviceAreas: Array.from(document.querySelectorAll('input[name="adviceAreas"]:checked')).map(cb => cb.value).join(', '),
                
                // Objectives
                primaryObjective: document.getElementById('primaryObjective').value,
                secondaryObjectives: document.getElementById('secondaryObjectives').value,
                timeHorizon: document.getElementById('timeHorizon').value,
                incomeRequirement: document.getElementById('incomeRequirement').value,
                
                // Section 2 - Financial Summary
                totalIncomeCurrent: document.getElementById('totalIncomeCurrent').textContent,
                totalIncomeExpected: document.getElementById('totalIncomeExpected').textContent,
                totalExpMonthly: document.getElementById('totalExpMonthly').textContent,
                totalExpAnnual: document.getElementById('totalExpAnnual').textContent,
                totalAssets: document.getElementById('totalAssets').textContent,
                totalLiabilities: document.getElementById('totalLiabilities').textContent,
                netWorth: document.getElementById('netWorth').textContent,
                annualSurplus: document.getElementById('annualSurplus').textContent,
                
                // Section 3 - Retirement Planning
                retirementAge: document.getElementById('retirementAge').value,
                lifeExpectancy: document.getElementById('lifeExpectancy').value,
                sustainableWithdrawalRate: document.getElementById('sustainableWithdrawalRate').value,
                inflationAssumption: document.getElementById('inflationAssumption').value,
                incomeGap: document.getElementById('incomeGap').value,
                incomeStrategy: document.getElementById('incomeStrategy').value,
                
                // Section 4 - Risk Assessment
                riskProfilingTool: document.getElementById('riskProfilingTool').value,
                riskScore: document.getElementById('riskScore').value,
                riskCategory: document.getElementById('riskCategory').value,
                emergencyFund: document.getElementById('emergencyFund').value,
                emergencyMonths: document.getElementById('emergencyMonths').value,
                maxAcceptableLoss: document.getElementById('maxAcceptableLoss').value,
                riskReconciliation: document.getElementById('riskReconciliation').value,
                
                // Section 5 - Knowledge & Experience
                investmentKnowledge: document.getElementById('investmentKnowledge').value,
                
                // Section 6 - Vulnerability
                vulnerabilities: Array.from(document.querySelectorAll('input[name="vulnerabilities"]:checked')).map(cb => cb.value).join(', '),
                vulnerabilityDetails: document.getElementById('vulnerabilityDetails').value,
                adaptationsMade: document.getElementById('adaptationsMade').value,
                
                // Section 7 - Options
                optionsConsidered: Array.from(document.querySelectorAll('input[name="options"]:checked')).map(cb => cb.value).join(', '),
                optionsAdvantages: document.getElementById('optionsAdvantages').value,
                optionsDisadvantages: document.getElementById('optionsDisadvantages').value,
                productResearch: document.getElementById('productResearch').value,
                
                // Section 8 - Recommendation
                recommendationSummary: document.getElementById('recommendationSummary').value,
                incomeStrategyDetail: document.getElementById('incomeStrategyDetail').value,
                investmentStrategyDetail: document.getElementById('investmentStrategyDetail').value,
                deathBenefitNominations: document.getElementById('deathBenefitNominations').value,
                
                // Section 9 - Suitability
                meetsObjectives: document.querySelector('input[name="meetsObjectives"]:checked')?.value || '',
                suitableRisk: document.querySelector('input[name="suitableRisk"]:checked')?.value || '',
                affordable: document.querySelector('input[name="affordable"]:checked')?.value || '',
                recommendationAdvantages: document.getElementById('recommendationAdvantages').value,
                recommendationDisadvantages: document.getElementById('recommendationDisadvantages').value,
                riskWarnings: Array.from(document.querySelectorAll('input[name="riskWarnings"]:checked')).map(cb => cb.value).join(', '),
                
                // Section 10 - Costs
                initialAdviserCharge: document.getElementById('initialAdviserCharge').value,
                initialAdviserChargePercent: document.getElementById('initialAdviserChargePercent').value,
                ongoingAdviserCharge: document.getElementById('ongoingAdviserCharge').value,
                platformCharge: document.getElementById('platformCharge').value,
                fundCharges: document.getElementById('fundCharges').value,
                totalOngoingCharges: document.getElementById('totalOngoingCharges').value,
                valueAssessment: document.getElementById('valueAssessment').value,
                
                // Section 11 - Documentation
                documentsProvided: Array.from(document.querySelectorAll('input[name="documents"]:checked')).map(cb => cb.value).join(', '),
                recordsKept: Array.from(document.querySelectorAll('input[name="recordKeeping"]:checked')).map(cb => cb.value).join(', '),
                
                // Section 12 - Quality Assurance
                adviserName: document.getElementById('adviserName').value,
                adviserNumber: document.getElementById('adviserNumber').value,
                adviserAssessment: document.getElementById('adviserAssessment').value,
                complianceReviewer: document.getElementById('complianceReviewer').value,
                complianceDate: document.getElementById('complianceDate').value,
                complianceComments: document.getElementById('complianceComments').value,
                
                // Section 13 - Declarations
                adviserDeclarations: Array.from(document.querySelectorAll('input[name="adviserDeclaration"]:checked')).map(cb => cb.value).join(', '),
                adviserSignature: document.getElementById('adviserSignature').value,
                adviserSignDate: document.getElementById('adviserSignDate').value,
                complianceSignature: document.getElementById('complianceSignature').value,
                complianceSignDate: document.getElementById('complianceSignDate').value,
                
                // Form completion
                formCompletionPercent: document.getElementById('progressFill').textContent
            };
            
            return data;
        }

        // Toggle section collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        // Add table rows
        function addAssetRow() {
            const tbody = document.getElementById('assetsTableBody');
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
                <td>
                    <select name="asset_type[]">
                        <option value="Property">Property</option>
                        <option value="Cash">Cash/Savings</option>
                        <option value="Investment">Investments</option>
                        <option value="Pension">Pension</option>
                        <option value="Business">Business</option>
                        <option value="Other">Other</option>
                    </select>
                </td>
                <td><input type="text" name="asset_description[]"></td>
                <td><input type="number" name="asset_value[]" min="0" step="100" onchange="calculateTotals()"></td>
                <td>
                    <select name="asset_ownership[]">
                        <option value="Sole">Sole</option>
                        <option value="Joint">Joint</option>
                        <option value="Trust">Trust</option>
                    </select>
                </td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
            `;
        }

        function addLiabilityRow() {
            const tbody = document.getElementById('liabilitiesTableBody');
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
                <td>
                    <select name="liability_type[]">
                        <option value="Mortgage">Mortgage</option>
                        <option value="Loan">Personal Loan</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Car Finance">Car Finance</option>
                        <option value="Other">Other</option>
                    </select>
                </td>
                <td><input type="text" name="liability_description[]"></td>
                <td><input type="number" name="liability_outstanding[]" min="0" step="100" onchange="calculateTotals()"></td>
                <td><input type="number" name="liability_payment[]" min="0" step="10"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
            `;
        }

        function addPensionRow() {
            const tbody = document.getElementById('pensionTableBody');
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
                <td><input type="text" name="pension_provider[]"></td>
                <td>
                    <select name="pension_type[]">
                        <option value="DC">Defined Contribution</option>
                        <option value="DB">Defined Benefit</option>
                        <option value="SIPP">SIPP</option>
                        <option value="State">State Pension</option>
                    </select>
                </td>
                <td><input type="number" name="pension_value[]" min="0" step="100"></td>
                <td><input type="number" name="pension_contribution[]" min="0" step="100"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
            `;
        }

        function addExperienceRow() {
            const tbody = document.getElementById('experienceTableBody');
            const newRow = tbody.insertRow(-1);
            newRow.innerHTML = `
                <td>
                    <select name="experience_type[]">
                        <option value="Cash">Cash/Deposits</option>
                        <option value="Bonds">Bonds/Fixed Income</option>
                        <option value="Equities">Equities/Shares</option>
                        <option value="Funds">Mutual Funds/OEICs</option>
                        <option value="ETFs">ETFs</option>
                        <option value="Property">Property</option>
                        <option value="Alternatives">Alternative Investments</option>
                    </select>
                </td>
                <td><input type="number" name="experience_years[]" min="0" max="50"></td>
                <td>
                    <select name="experience_current[]">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button></td>
            `;
        }

        function removeRow(button) {
            button.closest('tr').remove();
            calculateTotals();
            updateProgress();
        }

        // Calculations
        function calculateTotals() {
            // Income calculations
            let totalIncomeCurrent = 0;
            let totalIncomeExpected = 0;
            
            document.querySelectorAll('[name^="income_"][name$="_current"]').forEach(input => {
                totalIncomeCurrent += parseFloat(input.value) || 0;
            });
            
            document.querySelectorAll('[name^="income_"][name$="_expected"]').forEach(input => {
                totalIncomeExpected += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalIncomeCurrent').textContent = `¬£${totalIncomeCurrent.toLocaleString()}`;
            document.getElementById('totalIncomeExpected').textContent = `¬£${totalIncomeExpected.toLocaleString()}`;

            // Expenditure calculations
            let totalExpMonthly = 0;
            document.querySelectorAll('[name^="exp_"][name$="_monthly"]').forEach(input => {
                totalExpMonthly += parseFloat(input.value) || 0;
            });
            
            document.getElementById('totalExpMonthly').textContent = `¬£${totalExpMonthly.toLocaleString()}`;
            document.getElementById('totalExpAnnual').textContent = `¬£${(totalExpMonthly * 12).toLocaleString()}`;

            // Assets calculations
            let totalAssets = 0;
            document.querySelectorAll('[name="asset_value[]"]').forEach(input => {
                totalAssets += parseFloat(input.value) || 0;
            });
            document.getElementById('totalAssets').textContent = `¬£${totalAssets.toLocaleString()}`;

            // Liabilities calculations
            let totalLiabilities = 0;
            document.querySelectorAll('[name="liability_outstanding[]"]').forEach(input => {
                totalLiabilities += parseFloat(input.value) || 0;
            });
            document.getElementById('totalLiabilities').textContent = `¬£${totalLiabilities.toLocaleString()}`;

            // Net worth and surplus calculations
            const netWorth = totalAssets - totalLiabilities;
            document.getElementById('netWorth').textContent = `¬£${netWorth.toLocaleString()}`;

            const annualSurplus = totalIncomeCurrent - (totalExpMonthly * 12);
            document.getElementById('annualSurplus').textContent = `¬£${annualSurplus.toLocaleString()}`;
        }

        function calculateExpenditureAnnual(input) {
            const monthly = parseFloat(input.value) || 0;
            const annual = monthly * 12;
            const annualSpan = input.closest('tr').querySelector('[name$="_annual"]');
            annualSpan.textContent = `¬£${annual.toLocaleString()}`;
            calculateTotals();
        }

        function calculateIncomeGap() {
            const required = parseFloat(document.getElementById('requiredIncome').value) || 0;
            const secure = parseFloat(document.getElementById('secureIncome').value) || 0;
            const gap = required - secure;
            document.getElementById('incomeGap').value = `¬£${gap.toLocaleString()}`;
        }

        function calculateEmergencyMonths() {
            const emergencyFund = parseFloat(document.getElementById('emergencyFund').value) || 0;
            const monthlyExp = parseFloat(document.getElementById('totalExpMonthly').textContent.replace(/[¬£,]/g, '')) || 0;
            
            if (monthlyExp > 0) {
                const months = Math.floor(emergencyFund / monthlyExp);
                document.getElementById('emergencyMonths').value = `${months} months`;
            }
        }

        function calculateTotalCharges() {
            const ongoing = (parseFloat(document.getElementById('ongoingAdviserCharge').value) || 0) +
                           (parseFloat(document.getElementById('platformCharge').value) || 0) +
                           (parseFloat(document.getElementById('fundCharges').value) || 0);
            
            document.getElementById('totalOngoingCharges').value = `${ongoing.toFixed(2)}%`;
        }

        // Progress tracking
        function updateProgress() {
            const sections = 13;
            let completedSections = 0;

            for (let i = 1; i <= sections; i++) {
                const section = document.getElementById(`section${i}`);
                const requiredFields = section.querySelectorAll('[required]');
                const checkboxGroups = section.querySelectorAll('.checkbox-group');
                
                let sectionComplete = true;

                // Check required fields
                requiredFields.forEach(field => {
                    if (!field.value && field.type !== 'checkbox' && field.type !== 'radio') {
                        sectionComplete = false;
                    }
                });

                // Check radio groups
                const radioGroups = new Set();
                section.querySelectorAll('input[type="radio"][required]').forEach(radio => {
                    radioGroups.add(radio.name);
                });
                
                radioGroups.forEach(groupName => {
                    if (!section.querySelector(`input[name="${groupName}"]:checked`)) {
                        sectionComplete = false;
                    }
                });

                // Update status indicator
                const statusIndicator = document.getElementById(`status${i}`);
                if (sectionComplete && requiredFields.length > 0) {
                    statusIndicator.classList.remove('status-incomplete');
                    statusIndicator.classList.add('status-complete');
                    completedSections++;
                } else {
                    statusIndicator.classList.remove('status-complete');
                    statusIndicator.classList.add('status-incomplete');
                }
            }

            // Update progress bar
            const progress = Math.round((completedSections / sections) * 100);
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${progress}%`;
            progressFill.textContent = `${progress}%`;
        }

        // Save and load functions
        function saveForm() {
            const formData = new FormData(document.getElementById('suitabilityForm'));
            const data = {};
            
            // Get all form inputs
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }

            // Add table data
            data.tables = {
                assets: getTableData('assetsTableBody'),
                liabilities: getTableData('liabilitiesTableBody'),
                pensions: getTableData('pensionTableBody'),
                experience: getTableData('experienceTableBody')
            };

            // Generate unique ID
            const formId = `IFA_Form_${Date.now()}`;
            data.formId = formId;
            data.savedDate = new Date().toISOString();

            // Save to localStorage
            localStorage.setItem(formId, JSON.stringify(data));
            
            // Show save indicator
            showSaveIndicator();
            
            alert(`Form saved successfully!\nForm ID: ${formId}`);
        }

        function loadForm() {
            const formId = prompt('Enter Form ID to load:');
            if (!formId) return;

            const savedData = localStorage.getItem(formId);
            if (!savedData) {
                alert('Form not found!');
                return;
            }

            const data = JSON.parse(savedData);
            
            // Restore form fields
            Object.keys(data).forEach(key => {
                if (key !== 'tables' && key !== 'formId' && key !== 'savedDate') {
                    const elements = document.getElementsByName(key);
                    if (elements.length > 0) {
                        if (elements[0].type === 'checkbox' || elements[0].type === 'radio') {
                            elements.forEach(element => {
                                if (Array.isArray(data[key])) {
                                    element.checked = data[key].includes(element.value);
                                } else {
                                    element.checked = element.value === data[key];
                                }
                            });
                        } else {
                            elements[0].value = data[key];
                        }
                    }
                }
            });

            // Restore tables
            if (data.tables) {
                restoreTableData('assetsTableBody', data.tables.assets);
                restoreTableData('liabilitiesTableBody', data.tables.liabilities);
                restoreTableData('pensionTableBody', data.tables.pensions);
                restoreTableData('experienceTableBody', data.tables.experience);
            }

            calculateTotals();
            updateProgress();
            
            alert('Form loaded successfully!');
        }

        function autoSave() {
            const formData = new FormData(document.getElementById('suitabilityForm'));
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (data[key]) {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            }

            data.tables = {
                assets: getTableData('assetsTableBody'),
                liabilities: getTableData('liabilitiesTableBody'),
                pensions: getTableData('pensionTableBody'),
                experience: getTableData('experienceTableBody')
            };

            localStorage.setItem('IFA_Form_AutoSave', JSON.stringify(data));
        }

        function loadAutoSave() {
            const savedData = localStorage.getItem('IFA_Form_AutoSave');
            if (!savedData) return;

            if (confirm('Auto-saved data found. Would you like to restore it?')) {
                const data = JSON.parse(savedData);
                
                Object.keys(data).forEach(key => {
                    if (key !== 'tables') {
                        const elements = document.getElementsByName(key);
                        if (elements.length > 0) {
                            if (elements[0].type === 'checkbox' || elements[0].type === 'radio') {
                                elements.forEach(element => {
                                    if (Array.isArray(data[key])) {
                                        element.checked = data[key].includes(element.value);
                                    } else {
                                        element.checked = element.value === data[key];
                                    }
                                });
                            } else {
                                elements[0].value = data[key];
                            }
                        }
                    }
                });

                if (data.tables) {
                    restoreTableData('assetsTableBody', data.tables.assets);
                    restoreTableData('liabilitiesTableBody', data.tables.liabilities);
                    restoreTableData('pensionTableBody', data.tables.pensions);
                    restoreTableData('experienceTableBody', data.tables.experience);
                }

                calculateTotals();
                updateProgress();
            }
        }

        function getTableData(tableId) {
            const tbody = document.getElementById(tableId);
            const rows = Array.from(tbody.rows);
            return rows.map(row => {
                const inputs = row.querySelectorAll('input, select');
                return Array.from(inputs).map(input => ({
                    name: input.name,
                    value: input.value,
                    type: input.type,
                    checked: input.checked
                }));
            });
        }

        function restoreTableData(tableId, data) {
            if (!data || data.length === 0) return;
            
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            data.forEach(rowData => {
                const row = tbody.insertRow(-1);
                let cellIndex = 0;
                
                rowData.forEach(inputData => {
                    if (!row.cells[cellIndex]) {
                        row.insertCell(cellIndex);
                    }
                    
                    let element;
                    if (inputData.type === 'text' || inputData.type === 'number') {
                        element = document.createElement('input');
                        element.type = inputData.type;
                        element.name = inputData.name;
                        element.value = inputData.value;
                        
                        if (inputData.type === 'number') {
                            element.min = "0";
                            element.step = inputData.name.includes('value') || inputData.name.includes('outstanding') ? "100" : "10";
                            if (inputData.name.includes('income') || inputData.name.includes('asset') || inputData.name.includes('liability')) {
                                element.onchange = calculateTotals;
                            }
                        }
                    } else if (inputData.name && inputData.name.includes('[]')) {
                        element = document.createElement('select');
                        element.name = inputData.name;
                        
                        // Add appropriate options based on the select type
                        if (inputData.name.includes('asset_type')) {
                            element.innerHTML = `
                                <option value="Property">Property</option>
                                <option value="Cash">Cash/Savings</option>
                                <option value="Investment">Investments</option>
                                <option value="Pension">Pension</option>
                                <option value="Business">Business</option>
                                <option value="Other">Other</option>
                            `;
                        } else if (inputData.name.includes('liability_type')) {
                            element.innerHTML = `
                                <option value="Mortgage">Mortgage</option>
                                <option value="Loan">Personal Loan</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Car Finance">Car Finance</option>
                                <option value="Other">Other</option>
                            `;
                        }
                        // Add other select options as needed
                        
                        element.value = inputData.value;
                    }
                    
                    if (element) {
                        row.cells[cellIndex].appendChild(element);
                    }
                    
                    cellIndex++;
                });
                
                // Add remove button
                const removeCell = row.insertCell(-1);
                removeCell.innerHTML = '<button type="button" class="remove-btn" onclick="removeRow(this)">Remove</button>';
            });
        }

        function clearForm() {
            if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
                document.getElementById('suitabilityForm').reset();
                
                // Clear tables
                ['assetsTableBody', 'liabilitiesTableBody', 'pensionTableBody', 'experienceTableBody'].forEach(tableId => {
                    const tbody = document.getElementById(tableId);
                    tbody.innerHTML = '';
                    
                    // Add one empty row
                    if (tableId === 'assetsTableBody') addAssetRow();
                    else if (tableId === 'liabilitiesTableBody') addLiabilityRow();
                    else if (tableId === 'pensionTableBody') addPensionRow();
                    else if (tableId === 'experienceTableBody') addExperienceRow();
                });
                
                calculateTotals();
                updateProgress();
                
                // Clear auto-save
                localStorage.removeItem('IFA_Form_AutoSave');
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // Export functions
        function exportToCSV() {
            const formData = collectAllFormData();
            let csv = 'IFA Suitability Assessment Form\n';
            csv += `Export Date: ${new Date().toLocaleDateString()}\n\n`;

            // Add sections
            csv += 'Section 1: Client Details & Objectives\n';
            csv += formatDataForCSV(formData.section1);
            
            csv += '\nSection 2: Financial Assessment\n';
            csv += formatDataForCSV(formData.section2);
            csv += '\nIncome Analysis\n';
            csv += tableToCSV('incomeTable');
            csv += '\nExpenditure Analysis\n';
            csv += tableToCSV('expenditureTable');
            csv += '\nAssets\n';
            csv += tableToCSV('assetsTable');
            csv += '\nLiabilities\n';
            csv += tableToCSV('liabilitiesTable');
            
            // Add other sections...
            
            downloadFile(csv, 'IFA_Suitability_Assessment.csv', 'text/csv');
        }

        function exportToExcel() {
            // For Excel export, we'll create a formatted HTML table
            const formData = collectAllFormData();
            let html = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta charset="utf-8">
                    <style>
                        table { border-collapse: collapse; }
                        th, td { border: 1px solid black; padding: 8px; }
                        th { background-color: #4472C4; color: white; }
                        .section-header { background-color: #E7F1FF; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>IFA Suitability Assessment Form</h1>
                    <p>Export Date: ${new Date().toLocaleDateString()}</p>
            `;

            // Add all sections with proper formatting
            html += formatDataForExcel(formData);
            
            html += '</body></html>';
            
            downloadFile(html, 'IFA_Suitability_Assessment.xls', 'application/vnd.ms-excel');
        }

        function collectAllFormData() {
            const form = document.getElementById('suitabilityForm');
            const formData = new FormData(form);
            const data = {
                section1: {},
                section2: {},
                // ... other sections
            };

            // Collect data by sections
            // This is a simplified version - expand as needed
            for (let [key, value] of formData.entries()) {
                // Categorize by section based on field names
                if (key.startsWith('client') || key.startsWith('advice') || key.includes('Objective')) {
                    data.section1[key] = value;
                } else if (key.startsWith('income') || key.startsWith('exp') || key.startsWith('asset') || key.startsWith('liability')) {
                    data.section2[key] = value;
                }
                // Add other sections...
            }

            return data;
        }

        function formatDataForCSV(data) {
            let csv = '';
            Object.entries(data).forEach(([key, value]) => {
                csv += `"${key}","${value}"\n`;
            });
            return csv;
        }

        function tableToCSV(tableId) {
            const table = document.getElementById(tableId);
            let csv = '';
            
            // Headers
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
            csv += headers.join(',') + '\n';
            
            // Rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const values = [];
                row.querySelectorAll('td').forEach(cell => {
                    const input = cell.querySelector('input, select');
                    if (input) {
                        values.push(`"${input.value}"`);
                    } else {
                        values.push(`"${cell.textContent}"`);
                    }
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }

        function formatDataForExcel(data) {
            // Create HTML tables for Excel
            let html = '<table>';
            
            Object.entries(data).forEach(([section, sectionData]) => {
                html += `<tr><td colspan="2" class="section-header">${section.toUpperCase()}</td></tr>`;
                Object.entries(sectionData).forEach(([key, value]) => {
                    html += `<tr><td>${key}</td><td>${value}</td></tr>`;
                });
            });
            
            html += '</table>';
            return html;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function printForm() {
            window.print();
        }
    </script>
</body>
</html>
