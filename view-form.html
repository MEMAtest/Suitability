<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Suitability Assessment Form</title>
    <style>
        :root { --primary-blue: #003366; --secondary-blue: #4472C4; --light-blue: #E7F1FF; --gray-dark: #333333; --gray-medium: #666666; --gray-light: #E5E5E5; --success-green: #28A745; --warning-orange: #FFC107; --danger-red: #DC3545; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.6; color: var(--gray-dark); background-color: #F5F7FA; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background-color: var(--primary-blue); color: white; padding: 20px 0; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .form-controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        .btn-warning { background-color: var(--warning-orange); color: var(--gray-dark); }
        .section { background: white; padding: 25px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--light-blue); }
        .section-header h2 { color: var(--primary-blue); font-size: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--gray-dark); }
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 10px; border: 1px solid var(--gray-light); border-radius: 4px; font-size: 14px; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f8f9fa; color: #555; cursor: not-allowed; border-color: #dee2e6; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .checkbox-group, .radio-group { display: flex; flex-direction: column; gap: 10px; }
        .checkbox-item, .radio-item { display: flex; align-items: center; gap: 8px; }
        input[type="checkbox"], input[type="radio"] { width: 18px; height: 18px; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: var(--light-blue); color: var(--primary-blue); padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid var(--gray-light); }
        #suitabilityForm { pointer-events: none; } /* Disables clicks on the form area */
        .form-controls a.btn { pointer-events: auto; } /* Re-enables clicks on buttons in the controls area */
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 id="viewFormHeader">Viewing Form...</h1>
        </div>
    </header>

    <div class="container">
        <div class="form-controls">
            <a href="/index.html" class="btn btn-warning">‚¨ÖÔ∏è Back to Main Form</a>
            <button class="btn btn-warning" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>

        <form id="suitabilityForm">
             </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://maandodhonjolrmcxivo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hYW5kb2Rob25qb2xybWN4aXZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NDg3NjIsImV4cCI6MjA2NDEyNDc2Mn0.Ku89ldqO_b1ptFBQFtQPhzmmnrg04LpcMeCw21sjlAE';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // This improved function populates all fields, including complex ones
        function populateForm(formData) {
            for (const key in formData) {
                if (key === 'tables') continue; // Skip the tables object, it's handled separately

                const elements = document.getElementsByName(key);
                if (elements.length === 0) continue;

                const fieldType = elements[0].type;
                const value = formData[key];

                if (fieldType === 'checkbox' || fieldType === 'radio') {
                    const values = Array.isArray(value) ? value : [value];
                    elements.forEach(el => {
                        if (values.includes(el.value)) {
                            el.checked = true;
                        }
                    });
                } else if (elements.length > 1) { // Handle fields with multiple inputs like in tables
                     const values = Array.isArray(value) ? value : [value];
                     elements.forEach((el, index) => {
                         if (values[index]) {
                             el.value = values[index];
                         }
                     });
                } else { // Handle single fields (text, select, textarea, etc.)
                    elements[0].value = value;
                }
            }
        }

        // This improved function rebuilds the tables with the saved data
        function restoreTables(tablesData) {
            if (!tablesData) return;
            
            for (const tableName in tablesData) {
                const tableBodyId = `${tableName.slice(0, -1)}TableBody`; // e.g., 'assets' -> 'assetTableBody'
                const tbody = document.getElementById(tableBodyId);
                if (!tbody) continue;
                
                tbody.innerHTML = ''; // Clear any placeholder rows
                const tableRowsData = tablesData[tableName];

                tableRowsData.forEach(rowData => {
                    const newRow = tbody.insertRow();
                    const templateRow = tbody.closest('table').querySelector('thead tr');
                    
                    // Create a disabled input/select for each cell based on the form's structure
                    rowData.forEach(cellData => {
                        const cell = newRow.insertCell();
                        const input = document.createElement(cellData.type === 'select-one' ? 'select' : 'input');
                        input.type = cellData.type;
                        input.value = cellData.value;
                        input.disabled = true;
                        input.style.backgroundColor = '#fdfdfd';
                        input.style.color = '#333';
                        input.style.border = '1px solid #eee';

                        if(cellData.type === 'select-one') {
                            const option = document.createElement('option');
                            option.value = cellData.value;
                            option.textContent = cellData.value;
                            input.appendChild(option);
                        }
                        
                        cell.appendChild(input);
                    });
                });
            }
        }

        async function loadAndDisplayForm() {
            const params = new URLSearchParams(window.location.search);
            const formId = params.get('id');

            if (!formId) {
                document.getElementById('viewFormHeader').textContent = 'Error: No Form ID Provided';
                return;
            }

            const { data, error } = await supabaseClient
                .from('ifa_forms')
                .select('payload')
                .eq('form_id', formId)
                .single();

            if (error || !data) {
                console.error('Error fetching form:', error);
                document.getElementById('viewFormHeader').textContent = `Error: Could not load form ${formId}`;
                return;
            }

            const formData = data.payload.formData;
            const clientName = `${formData.firstName || ''} ${formData.lastName || ''}`;
            document.getElementById('viewFormHeader').textContent = `Viewing Form for: ${clientName.trim()}`;

            // Populate all fields from the saved data
            populateForm(formData);
            
            // Rebuild the tables with the saved data
            restoreTables(formData.tables);

            // Disable the entire form to make it read-only
            document.getElementById('suitabilityForm').querySelectorAll('input, select, textarea').forEach(el => {
                el.disabled = true;
            });
        }

        document.addEventListener('DOMContentLoaded', loadAndDisplayForm);
    </script>
</body>
</html>
